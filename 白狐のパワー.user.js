// ==UserScript==
// @name        White Fox Power
// @namespace   X+
// @match       *://*.whiteboardfox.com/*
// @run-at      document-start
// @homepageURL https://github.com/reino08/ByakkoNoPawaa
// @downloadURL https://reino08.github.io/ByakkoNoPawaa/白狐のパワー.user.js
// @noframes
// @grant       unsafeWindow
// @grant       GM.xmlHttpRequest
// @grant       GM_addElement
// @grant       GM_getValue
// @grant       GM_setValue
// ==/UserScript==
var e="AIzaSyC8xW9BmOuZJJknjuXLozD-0wfRdExoZMQ";function t(e){if("complete"==document.readyState)return e();window.addEventListener("load",e)}let n,o;const i=[];function r(e){if(o)return e(o);i.push(e),n||(n=setInterval((()=>{o=document.getElementById("canvasId"),o&&(clearInterval(n),i.forEach((e=>e(o))),i.splice(0))}),100))}const a=document.getElementsByTagName("h1")?.[0]?.textContent?.includes("403");(a||"/login.jsp"==document.location.pathname)&&t((async()=>{const t="abcdefghijklmnopqrstuvwxyz",n=e=>new Array(e).fill(0).map((e=>t[Math.floor(26*Math.random())])).join("");await d(`${document.location.origin}/logout`);const o=n(10),i=await async function(t,n,o){await fetch(`${c}/createAuthUri?key=${e}`,{...s,body:JSON.stringify({identifier:t,continueUri:`${document.location.origin}/login.jsp`})});let{idToken:i}=await fetch(`${c}/signupNewUser?key=${e}`,{...s,body:JSON.stringify({email:t,password:o,returnSecureToken:!0})}).then((e=>e.json()));return await fetch(`${c}/setAccountInfo?key=${e}`,{...s,body:JSON.stringify({idToken:i,displayName:n,returnSecureToken:!0})}),i}(`${n(16)}@${n(16)}.com`,o,n(20));var r;if(await function(e,t){return d(`${document.location.origin}/login?idToken=${e}&name=${encodeURI(t)}&redirect=%2F`)}(i,o),await(r=1250,new Promise((e=>setTimeout(e,r)))),a)return document.location.reload();const l=document.location.search,u=l.indexOf("redirect=");let f=l.substring(u).indexOf("&");if(-1==u)return document.location=document.location.origin;-1==f&&(f=void 0),document.location=document.location.origin+"/"+l.substring(u+9,f)}));const c="https://www.googleapis.com/identitytoolkit/v3/relyingparty",s={method:"POST",headers:[["Content-Type","application/json"]]};async function d(e){new Promise((t=>{const n=document.createElement("iframe");n.style.display="none",n.src=e,n.onload=()=>t(n.remove()),document.body.appendChild(n)}))}async function l(){let e=0,t=0,n=1;do{let{docs:o,totalCount:i}=await fetch(`${document.location.origin}/lobby?page=${n}`).then((e=>e.json()));e=i,t+=o.length,n++;for(let e of o){const t=document.createElement("div");t.className="wfp-board",document.body.appendChild(t),u(e,t)}}while(t<e)}async function u({domainUrl:e,diagramName:t,preferredUserName:n,activeUsers:o},i){const r=`${e}${t}`,a=document.createElement("a");a.href=r,a.textContent=`${n} (${o})`,i.appendChild(a),GM.xmlHttpRequest({url:r,method:"HEAD",onload:function(e){403==e.status&&(a.style.textDecoration="line-through")}})}"/lobby.jsp"==document.location.pathname&&(document.close(),t((()=>{document.body.innerHTML="";{const e=document.createElement("button");e.style.all="revert",e.textContent="Refresh",e.onclick=()=>{for(let e=document.getElementsByClassName("wfp-board"),t=e.length-1;t>=0;t--)e[t].parentNode.removeChild(e[t]);l()},document.body.appendChild(e)}l()})));/\/[0-9]{8}-[0-9]{4}-[0-9]{4}/.test(document.location.pathname)&&(Promise.resolve().then((function(){return k})),Promise.resolve().then((function(){return S})));let f=unsafeWindow.prompt;document.addEventListener("keydown",(e=>{if("g"!=e.key)return;let t=prompt("Enter repeated text (empty to clear):").substring(0,200);unsafeWindow.prompt=t?()=>t:f}));const m=[],p=new Proxy(new class{constructor(e){this.min_framerate=0,this.downscale=!1,this.skip_old=!1,this.auto_reload=!1,Object.assign(this,e)}}(GM_getValue("wfp-config",{})),{set(e,t,n,o){let i=e[t];if(i==n)return;let r=Reflect.set(e,t,n,o);return GM_setValue("wfp-config",p),"string"==typeof t&&m.forEach((e=>e(t,i,n))),r}});function h(e){e(void 0,p),m.push((t=>e(t,p)))}let g;r((e=>{g=e;const t=new MutationObserver(o),n={attributes:!0,attributeFilter:["width","height"]};function o(){t.disconnect();let e=g?.getBoundingClientRect();p?.downscale?(g.width=e.width/2,g.height=e.height/2):(g.width=e.width,g.height=e.height),t.observe(g,n)}t.observe(g,n),h((e=>{e&&"downscale"!=e||o()}))}));let w=EventTarget.prototype.addEventListener;EventTarget.prototype.addEventListener=function(e,t,n){return w.call(this,e,(function(e){if(e.clientX){let t=g?.getBoundingClientRect();if(t&&p?.downscale&&e.clientX>=t.x&&e.clientX<=t.x+t.width&&e.clientY>=t.y&&e.clientY<=t.y+t.height){console.log(t.width,g.width);let n=(e.clientX-t.x)*Math.SQRT1_2+t.x,o=(e.clientY-t.y)*Math.SQRT1_2+t.y;e.__defineGetter__("clientX",(()=>n)),e.__defineGetter__("clientY",(()=>o))}}return"function"==typeof t?t.call(this,e):t.handleEvent.call(this,e)}),n)};let y=performance.now(),b=0,v=!1;const E=["fillText","stroke"];!function e(){y=performance.now(),requestAnimationFrame(e)}(),h(((e,t)=>{e&&"min_framrate"!=e||(t.min_framerate?(b=1e3/t.min_framerate,v||(E.forEach((e=>function(e,t){const n=e[t];e[t]=function(){if(performance.now()-y<b)return n.apply(this,arguments)},e[t].original=n}(CanvasRenderingContext2D.prototype,e))),v=!0)):v&&(E.forEach((e=>function(e,t){e[t]=e[t].original}(CanvasRenderingContext2D.prototype,e))),v=!1))}));let _=document.createElement;document.createElement=function(e){let t=_.apply(this,arguments);return"iframe"!=e||Object.defineProperty(t,"contentWindow",{configurable:!0,get:()=>{delete t.contentWindow;let e=t.contentWindow,n=e.document.write;return e.document.write=function(e){return n.call(this,e+'<script>!function(){"use strict";let e;const t=[];function n(t,n){if(!e?.skip_old||"g"!=n.data[0])return t.call(this,n)}window.addEventListener("message",(n=>{if(!Array.isArray(n.data)||n.data.length<1)return;let[a,...o]=n.data;if("set-all"!=a)return console.warn("Unknown command",a);e=JSON.parse(o[0]),t.forEach((e=>e()))})),window.parent.postMessage(["get-all"]),WebSocket=new Proxy(WebSocket,{construct(t,a){let o=new t(...a);return o.addEventListener("close",(()=>{e?.auto_reload&&window.top.document.location.reload()})),Object.defineProperty(o,"onmessage",{set:e=>o.addEventListener("message",n.bind(o,e))}),o}})}();\n<\/script>')},m.push((()=>t.contentWindow.postMessage(["set-all",JSON.stringify(p)],"*"))),e}}),t};const x=unsafeWindow.alert;unsafeWindow.alert=function(e){if(!p?.auto_reload||"Connection to server was lost - please refresh page to reconnect"!=e)return x.apply(this,arguments)};var k=Object.freeze({__proto__:null}),C=[],O=[];!function(e,t){if(e&&"undefined"!=typeof document){var n,o=!0===t.prepend?"prepend":"append",i=!0===t.singleTag,r="string"==typeof t.container?document.querySelector(t.container):document.getElementsByTagName("head")[0];if(i){var a=C.indexOf(r);-1===a&&(a=C.push(r)-1,O[a]={}),n=O[a]&&O[a][o]?O[a][o]:O[a][o]=c()}else n=c();65279===e.charCodeAt(0)&&(e=e.substring(1)),n.styleSheet?n.styleSheet.cssText+=e:n.appendChild(document.createTextNode(e))}function c(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),t.attributes)for(var n=Object.keys(t.attributes),i=0;i<n.length;i++)e.setAttribute(n[i],t.attributes[n[i]]);var a="prepend"===o?"afterbegin":"beforeend";return r.insertAdjacentElement(a,e),e}}(":has(>#feedback-banner){display:none}:has(>#canvasId){width:calc(100% - 440px)}#canvasId{height:100vh;width:100%}#wfp-ui-root{border:0;height:100vh;position:fixed;right:0;width:300px}#bottom-ad-area,#right-ad-area{display:none!important}",{}),r((e=>{GM_addElement(e.parentElement.parentElement.parentElement,"iframe",{id:"wfp-ui-root",src:"https://reino08.github.io/ByakkoNoPawaa#"+encodeURI(JSON.stringify(p))})})),window.addEventListener("message",(e=>{if(!Array.isArray(e.data)||e.data.length<1)return;const[t,...n]=e.data;if("set"==t){const[e,t]=n;p[e]=t}else"get-all"==t?e.source.postMessage(["set-all",JSON.stringify(p)]):console.warn("Unknown command",t)}));var S=Object.freeze({__proto__:null});
