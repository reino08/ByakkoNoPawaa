// ==UserScript==
// @name        White Fox Power
// @namespace   X+
// @match       *://*.whiteboardfox.com/*
// @run-at      document-start
// @homepageURL https://github.com/reino08/ByakkoNoPawaa
// @downloadURL https://reino08.github.io/ByakkoNoPawaa/白狐のパワー.user.js
// @noframes
// @grant       unsafeWindow
// @grant       GM.xmlHttpRequest
// ==/UserScript==
var e="AIzaSyC8xW9BmOuZJJknjuXLozD-0wfRdExoZMQ";function t(e){if("complete"==document.readyState)return e();window.addEventListener("load",e)}function n(e){return new Promise((t=>setTimeout(t,e)))}"/login.jsp"==document.location.pathname?t((async()=>{const t="abcdefghijklmnopqrstuvwxyz",r=e=>new Array(e).fill(0).map((e=>t[Math.floor(26*Math.random())])).join("");await a();const d=r(10),l=await async function(t,n,a){await fetch(`${o}/createAuthUri?key=${e}`,{...i,body:JSON.stringify({identifier:t,continueUri:`${document.location.origin}/login.jsp`})});let{idToken:c}=await fetch(`${o}/signupNewUser?key=${e}`,{...i,body:JSON.stringify({email:t,password:a,returnSecureToken:!0})}).then((e=>e.json()));return await fetch(`${o}/setAccountInfo?key=${e}`,{...i,body:JSON.stringify({idToken:c,displayName:n,returnSecureToken:!0})}),c}(`${r(16)}@${r(16)}.com`,d,r(20));await function(e,t){return c(`${document.location.origin}/login?idToken=${e}&name=${encodeURI(t)}&redirect=%2F`)}(l,d),await n(1250);const s=document.location.search,m=s.indexOf("redirect=");let u=s.substring(m).indexOf("&");if(-1==m)return document.location=document.location.origin;-1==u&&(u=void 0),document.location=document.location.origin+"/"+s.substring(m+9,u)})):document.getElementsByTagName("h1")?.[0]?.textContent?.includes("403")&&t((async()=>{await a(),await n(1250),document.location.reload()}));const o="https://www.googleapis.com/identitytoolkit/v3/relyingparty",i={method:"POST",headers:[["Content-Type","application/json"]]};function a(){return c(`${document.location.origin}/logout`)}async function c(e){new Promise((t=>{const n=document.createElement("iframe");n.style.display="none",n.src=e,n.onload=()=>t(n.remove()),document.body.appendChild(n)}))}let r=unsafeWindow.prompt;async function d(){let e=0,t=0,n=1;do{let{docs:o,totalCount:i}=await fetch(`${document.location.origin}/lobby?page=${n}`).then((e=>e.json()));e=i,t+=o.length,n++;for(let e of o){const t=document.createElement("div");t.className="wfp-board",document.body.appendChild(t),l(e,t)}}while(t<e)}async function l({domainUrl:e,diagramName:t,preferredUserName:n,activeUsers:o},i){const a=`${e}/${t}`,c=document.createElement("a");c.href=a,c.textContent=`${n} (${o})`,i.appendChild(c),GM.xmlHttpRequest({url:a,method:"HEAD",onload:function(e){403==e.status&&(c.style.textDecoration="line-through")}})}/\/[0-9]{8}-[0-9]{4}-[0-9]{4}/.test(document.location.pathname)&&document.addEventListener("keydown",(e=>{if("g"==e.key){let e=prompt("Enter repeated text (empty to clear):");unsafeWindow.prompt=e?()=>e:r}})),"/lobby.jsp"==document.location.pathname&&(document.close(),t((()=>{document.body.innerHTML="";{const e=document.createElement("button");e.style.all="revert",e.textContent="Refresh",e.onclick=()=>{for(let e=document.getElementsByClassName("wfp-board"),t=e.length-1;t>=0;t--)e[t].parentNode.removeChild(e[t]);d()},document.body.appendChild(e)}d()})));
