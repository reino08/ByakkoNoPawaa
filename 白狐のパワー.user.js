// ==UserScript==
// @name        White Fox Power
// @namespace   X+
// @match       *://*.whiteboardfox.com/*
// @run-at      document-start
// @homepageURL https://github.com/reino08/ByakkoNoPawaa
// @downloadURL https://reino08.github.io/ByakkoNoPawaa/白狐のパワー.user.js
// @noframes
// @grant       unsafeWindow
// @grant       GM.xmlHttpRequest
// @grant       GM_addElement
// @grant       GM_getValue
// @grant       GM_setValue
// ==/UserScript==
const e=[],t=new Proxy(new class{constructor(e){this.min_framerate=0,this.downscale=!1,this.skip_old=!1,this.auto_reload=!1,this.username_prefix="",Object.assign(this,e)}}(GM_getValue("wfp-config",{})),{set(n,o,i,r){let a=n[o];if(a==i)return;let c=Reflect.set(n,o,i,r);return GM_setValue("wfp-config",t),"string"==typeof o&&e.forEach((e=>e(o,a,i))),c}});function n(n){n(void 0,t),e.push((e=>n(e,t)))}let o=document.createElement;document.createElement=function(n){let i=o.apply(this,arguments);return"iframe"!=n||Object.defineProperty(i,"contentWindow",{configurable:!0,get:()=>{delete i.contentWindow;let n=i.contentWindow,o=n.document.write;return n.document.write=function(e){return o.call(this,e+'<script>!function(){"use strict";const t=window.parent[Symbol.for("WFP")].settings;function n(n,e){if(!t?.skip_old||"g"!=e.data[0])return n.call(this,e)}WebSocket=new Proxy(WebSocket,{construct(e,o){let i=new e(...o);return i.addEventListener("close",(()=>{t?.auto_reload&&window.top.document.location.reload()})),Object.defineProperty(i,"onmessage",{set:t=>i.addEventListener("message",n.bind(i,t))}),i}});const e=new Promise((t=>{let n=window.parent.whiteboard.__sendStats;window.parent.whiteboard.__sendStats=function(e,o){return"end"==o&&function(t){let n=Object.entries(window),e=n.filter((([t,n])=>"function"==typeof n&&!n.toString().includes("[native code]")));t({all:n,functions:e})}(t),n.apply(this,arguments)}}));e.then((t=>{const n="$wnd.alert("+t.all.find((([t,n])=>"Copy command and image upload are currently disabled."==n))[0]+")";let e=t.functions.filter((([t,e])=>e.toString().includes(n)));for(const[t,o]of e){const e=o.toString(),i=e.indexOf(n);window[t]=new Function("return "+e.substring(0,i)+e.substring(i).replace("return","").replace(n,""))()}}))}();\n<\/script>')},e.push((()=>i.contentWindow.postMessage(["set-all",JSON.stringify(t)],"*"))),n}}),i};var i="AIzaSyC8xW9BmOuZJJknjuXLozD-0wfRdExoZMQ";const r="/lobby.jsp"==document.location.pathname,a="/login.jsp"==document.location.pathname,c=document.getElementsByTagName("h1")?.[0]?.textContent?.includes("403"),s=/\/[0-9]{8}-[0-9]{4}-[0-9]{4}/.test(document.location.pathname);function l(e){if("complete"==document.readyState)return e();window.addEventListener("load",e)}let d,u;const f=[];function p(e){if(s){if(u)return e(u);f.push(e),d||(d=setInterval((()=>{u=document.getElementById("canvasId"),u&&(clearInterval(d),f.forEach((e=>e(u))),f.splice(0))}),100))}}(c||a)&&l((async()=>{const e="abcdefghijklmnopqrstuvwxyz",n=e=>t=>new Array(t).fill(0).map((t=>e[Math.floor(Math.random()*e.length)])).join(""),o=n(e),r=o(10),a=await async function(e,t,n){await fetch(`${m}/createAuthUri?key=${i}`,{...h,body:JSON.stringify({identifier:e,continueUri:`${document.location.origin}/login.jsp`})}).catch(console.error);let{idToken:o}=await fetch(`${m}/signupNewUser?key=${i}`,{...h,body:JSON.stringify({email:e,password:n,returnSecureToken:!0})}).then((e=>e.json())).catch(console.error);return await fetch(`${m}/setAccountInfo?key=${i}`,{...h,body:JSON.stringify({idToken:o,displayName:t,returnSecureToken:!0})}),o}(`${o(16)}@${o(16)}.com`,r,o(20));if(await function(e,t){return async function(e){return new Promise((t=>{const n=document.createElement("iframe");n.style.display="none",n.src=e,n.onload=()=>t(n.remove()),document.body.appendChild(n)}))}(`${document.location.origin}/login?idToken=${e}&name=${encodeURI(t)}&redirect=%2F`)}(a,r),t.username_prefix){let o=t.username_prefix.trim();if(/^[a-zA-Z0-9._]{1,32}$/.test(o)){const t=new FormData;t.append("preferredUserName",o+n(e+"1234567890_.")(32-o.length)),await fetch(location.origin+"/api/user",{body:t,method:"PUT"}).catch((()=>{}))}else alert(`Invaild username prefix. Was "${o}". Removing.`),t.username_prefix=""}if(c)return document.location.reload();const s=document.location.search,l=s.indexOf("redirect=");let d=s.substring(l).indexOf("&");if(-1==l)return document.location=document.location.origin;-1==d&&(d=void 0),document.location=document.location.origin+"/"+s.substring(l+9,d)}));const m="https://www.googleapis.com/identitytoolkit/v3/relyingparty",h={method:"POST",headers:[["Content-Type","application/json"]]};const w=unsafeWindow.prompt;let g;s&&document.addEventListener("keydown",(e=>{if("g"!=e.key)return;let t=prompt("Enter repeated text (empty to clear):").substring(0,200);unsafeWindow.prompt=t?()=>t:w})),p((e=>{g=e;const o=new MutationObserver(r),i={attributes:!0,attributeFilter:["width","height"]};function r(){o.disconnect();let e=g?.getBoundingClientRect();t?.downscale?(g.width=e.width/2,g.height=e.height/2):(g.width=e.width,g.height=e.height),o.observe(g,i)}o.observe(g,i),n((e=>{e&&"downscale"!=e||r()}))}));let y=EventTarget.prototype.addEventListener;EventTarget.prototype.addEventListener=function(e,n,o){return y.call(this,e,(function(e){if(e.clientX){let n=g?.getBoundingClientRect();if(n&&t?.downscale&&e.clientX>=n.x&&e.clientX<=n.x+n.width&&e.clientY>=n.y&&e.clientY<=n.y+n.height){console.log(n.width,g.width);let t=(e.clientX-n.x)*Math.SQRT1_2+n.x,o=(e.clientY-n.y)*Math.SQRT1_2+n.y;e.__defineGetter__("clientX",(()=>t)),e.__defineGetter__("clientY",(()=>o))}}return"function"==typeof n?n.call(this,e):n.handleEvent.call(this,e)}),o)};let v=performance.now(),b=0,_=!1;const E=["fillText","stroke"];!function e(){v=performance.now(),requestAnimationFrame(e)}(),n(((e,t)=>{e&&"min_framrate"!=e||(t.min_framerate?(b=1e3/t.min_framerate,_||(E.forEach((e=>function(e,t){const n=e[t];e[t]=function(){if(performance.now()-v<b)return n.apply(this,arguments)},e[t].original=n}(CanvasRenderingContext2D.prototype,e))),_=!0)):_&&(E.forEach((e=>function(e,t){e[t]=e[t].original}(CanvasRenderingContext2D.prototype,e))),_=!1))}));const x=unsafeWindow.alert;let k;unsafeWindow.alert=function(e){if(!t?.auto_reload||"Connection to server was lost - please refresh page to reconnect"!=e)return x.apply(this,arguments)};var C=Object.freeze({__proto__:null,start:function(){const e=document.getElementById("canvasId"),t=e.getBoundingClientRect(),n=Math.floor(t.left),o=Math.floor(t.top),i=Math.floor(t.width),r=Math.floor(t.height);k&&clearInterval(k),k=setInterval((()=>{let t=e=>Math.floor(Math.random()*e);e.dispatchEvent(new MouseEvent("mousedown",{clientX:n+t(i),clientY:o+t(r)})),e.dispatchEvent(new MouseEvent("mousemove",{clientX:n+t(i),clientY:o+t(r)})),e.dispatchEvent(new MouseEvent("mouseup"))}))},stop:function(){clearInterval(k),k=void 0}});let S;var I=Object.freeze({__proto__:null,start:function(){S&&clearInterval(S),S=setInterval((()=>{document.body.dispatchEvent(new KeyboardEvent("keydown",{keyCode:67}))}))},stop:function(){clearInterval(S),S=void 0}});let M;function O(){clearInterval(M),M=void 0}var $=Object.freeze({__proto__:null,start:function(){M&&clearInterval(M),unsafeWindow.prompt!=w?M=setInterval((()=>{unsafeWindow.prompt==w&&O(),document.body.dispatchEvent(new KeyboardEvent("keydown",{keyCode:84}))})):alert("Set text by pressing `g` first")},stop:O}),T=Object.freeze({__proto__:null,randomDraw:C,spamCopy:I,spamText:$}),j=[],N=[];async function W(){let e=0,t=0,n=1;do{let{docs:o,totalCount:i}=await fetch(`${document.location.origin}/lobby?page=${n}`).then((e=>e.json()));e=i,t+=o.length,n++;for(let e of o){const t=document.createElement("div");t.className="wfp-board",document.body.appendChild(t),R(e,t)}}while(t<e)}async function R({domainUrl:e,diagramName:t,preferredUserName:n,activeUsers:o},i){const r=`${e}${t}`,a=document.createElement("a");a.href=r,a.textContent=`${n} (${o})`,i.appendChild(a),GM.xmlHttpRequest({url:r,method:"HEAD",onload:function(e){403==e.status&&(a.style.textDecoration="line-through")}})}!function(e,t){if(e&&"undefined"!=typeof document){var n,o=!0===t.prepend?"prepend":"append",i=!0===t.singleTag,r="string"==typeof t.container?document.querySelector(t.container):document.getElementsByTagName("head")[0];if(i){var a=j.indexOf(r);-1===a&&(a=j.push(r)-1,N[a]={}),n=N[a]&&N[a][o]?N[a][o]:N[a][o]=c()}else n=c();65279===e.charCodeAt(0)&&(e=e.substring(1)),n.styleSheet?n.styleSheet.cssText+=e:n.appendChild(document.createTextNode(e))}function c(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),t.attributes)for(var n=Object.keys(t.attributes),i=0;i<n.length;i++)e.setAttribute(n[i],t.attributes[n[i]]);var a="prepend"===o?"afterbegin":"beforeend";return r.insertAdjacentElement(a,e),e}}(":has(>#feedback-banner){display:none}:has(>#canvasId){width:calc(100% - 440px)}#canvasId{height:100vh;width:100%}#wfp-ui-root{border:0;height:100vh;position:fixed;right:0;width:300px}#bottom-ad-area,#right-ad-area{display:none!important}div:has(>.liveUsersPanel){height:100%!important;top:0!important}",{}),p((e=>{GM_addElement(e.parentElement.parentElement.parentElement,"iframe",{id:"wfp-ui-root",src:"https://reino08.github.io/ByakkoNoPawaa#"+encodeURI(JSON.stringify(t))})})),window.addEventListener("message",(e=>{if(!Array.isArray(e.data)||e.data.length<1)return;const[n,...o]=e.data;if("set"==n){const[e,n]=o;t[e]=n}else if("macro"==n){const[e,t]=o;T[e][t?"start":"stop"]()}else console.warn("Unknown command",n)})),r&&(document.close(),l((()=>{document.body.innerHTML="";{const e=document.createElement("button");e.style.all="revert",e.textContent="Refresh",e.onclick=()=>{for(let e=document.getElementsByClassName("wfp-board"),t=e.length-1;t>=0;t--)e[t].parentNode.removeChild(e[t]);W()},document.body.appendChild(e)}W()}))),unsafeWindow[Symbol.for("WFP")]={settings:t};
