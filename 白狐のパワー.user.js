// ==UserScript==
// @name        White Fox Power
// @namespace   X+
// @match       *://*.whiteboardfox.com/*
// @run-at      document-start
// @homepageURL https://github.com/reino08/ByakkoNoPawaa
// @downloadURL https://reino08.github.io/ByakkoNoPawaa/白狐のパワー.user.js
// @noframes
// @grant       unsafeWindow
// @grant       GM.xmlHttpRequest
// @grant       GM_addElement
// @grant       GM_getValue
// @grant       GM_setValue
// ==/UserScript==
var e="AIzaSyC8xW9BmOuZJJknjuXLozD-0wfRdExoZMQ";function t(e){if("complete"==document.readyState)return e();window.addEventListener("load",e)}let n,o;const i=[];function a(e){if(o)return e(o);i.push(e),n||(n=setInterval((()=>{o=document.getElementById("canvasId"),o&&(clearInterval(n),i.forEach((e=>e(o))),i.splice(0))}),100))}function r(e){return new Promise((t=>setTimeout(t,e)))}"/login.jsp"==document.location.pathname?t((async()=>{const t="abcdefghijklmnopqrstuvwxyz",n=e=>new Array(e).fill(0).map((e=>t[Math.floor(26*Math.random())])).join("");await d();const o=n(10),i=await async function(t,n,o){await fetch(`${c}/createAuthUri?key=${e}`,{...s,body:JSON.stringify({identifier:t,continueUri:`${document.location.origin}/login.jsp`})});let{idToken:i}=await fetch(`${c}/signupNewUser?key=${e}`,{...s,body:JSON.stringify({email:t,password:o,returnSecureToken:!0})}).then((e=>e.json()));return await fetch(`${c}/setAccountInfo?key=${e}`,{...s,body:JSON.stringify({idToken:i,displayName:n,returnSecureToken:!0})}),i}(`${n(16)}@${n(16)}.com`,o,n(20));await function(e,t){return l(`${document.location.origin}/login?idToken=${e}&name=${encodeURI(t)}&redirect=%2F`)}(i,o),await r(1250);const a=document.location.search,u=a.indexOf("redirect=");let f=a.substring(u).indexOf("&");if(-1==u)return document.location=document.location.origin;-1==f&&(f=void 0),document.location=document.location.origin+"/"+a.substring(u+9,f)})):document.getElementsByTagName("h1")?.[0]?.textContent?.includes("403")&&t((async()=>{await d(),await r(1250),document.location.reload()}));const c="https://www.googleapis.com/identitytoolkit/v3/relyingparty",s={method:"POST",headers:[["Content-Type","application/json"]]};function d(){return l(`${document.location.origin}/logout`)}async function l(e){new Promise((t=>{const n=document.createElement("iframe");n.style.display="none",n.src=e,n.onload=()=>t(n.remove()),document.body.appendChild(n)}))}async function u(){let e=0,t=0,n=1;do{let{docs:o,totalCount:i}=await fetch(`${document.location.origin}/lobby?page=${n}`).then((e=>e.json()));e=i,t+=o.length,n++;for(let e of o){const t=document.createElement("div");t.className="wfp-board",document.body.appendChild(t),f(e,t)}}while(t<e)}async function f({domainUrl:e,diagramName:t,preferredUserName:n,activeUsers:o},i){const a=`${e}${t}`,r=document.createElement("a");r.href=a,r.textContent=`${n} (${o})`,i.appendChild(r),GM.xmlHttpRequest({url:a,method:"HEAD",onload:function(e){403==e.status&&(r.style.textDecoration="line-through")}})}"/lobby.jsp"==document.location.pathname&&(document.close(),t((()=>{document.body.innerHTML="";{const e=document.createElement("button");e.style.all="revert",e.textContent="Refresh",e.onclick=()=>{for(let e=document.getElementsByClassName("wfp-board"),t=e.length-1;t>=0;t--)e[t].parentNode.removeChild(e[t]);u()},document.body.appendChild(e)}u()})));/\/[0-9]{8}-[0-9]{4}-[0-9]{4}/.test(document.location.pathname)&&(Promise.resolve().then((function(){return C})),Promise.resolve().then((function(){return T})));let m=unsafeWindow.prompt;document.addEventListener("keydown",(e=>{if("g"!=e.key)return;let t=prompt("Enter repeated text (empty to clear):").substring(0,200);unsafeWindow.prompt=t?()=>t:m}));const p=[],h=new Proxy(new class{constructor(e){this.min_framerate=0,this.downscale=!1,this.skip_old=!1,this.auto_reload=!1,Object.assign(this,e)}}(GM_getValue("wfp-config",{})),{set(e,t,n,o){let i=e[t];if(i==n)return;let a=Reflect.set(e,t,n,o);return GM_setValue("wfp-config",h),"string"==typeof t&&p.forEach((e=>e(t,i,n))),a}});function g(e){e(void 0,h),p.push((t=>e(t,h)))}let w;a((e=>{w=e;const t=new MutationObserver(o),n={attributes:!0,attributeFilter:["width","height"]};function o(){t.disconnect();let e=w?.getBoundingClientRect();h?.downscale?(w.width=e.width/2,w.height=e.height/2):(w.width=e.width,w.height=e.height),t.observe(w,n)}t.observe(w,n),g((e=>{e&&"downscale"!=e||o()}))}));let y=EventTarget.prototype.addEventListener;EventTarget.prototype.addEventListener=function(e,t,n){return y.call(this,e,(function(e){if(e.clientX){let t=w?.getBoundingClientRect();if(t&&h?.downscale&&e.clientX>=t.x&&e.clientX<=t.x+t.width&&e.clientY>=t.y&&e.clientY<=t.y+t.height){console.log(t.width,w.width);let n=(e.clientX-t.x)*Math.SQRT1_2+t.x,o=(e.clientY-t.y)*Math.SQRT1_2+t.y;e.__defineGetter__("clientX",(()=>n)),e.__defineGetter__("clientY",(()=>o))}}return"function"==typeof t?t.call(this,e):t.handleEvent.call(this,e)}),n)};let b=performance.now(),v=0,E=!1;const _=["fillText","stroke"];!function e(){b=performance.now(),requestAnimationFrame(e)}(),g(((e,t)=>{e&&"min_framrate"!=e||(t.min_framerate?(v=1e3/t.min_framerate,E||(_.forEach((e=>function(e,t){const n=e[t];e[t]=function(){if(performance.now()-b<v)return n.apply(this,arguments)},e[t].original=n}(CanvasRenderingContext2D.prototype,e))),E=!0)):E&&(_.forEach((e=>function(e,t){e[t]=e[t].original}(CanvasRenderingContext2D.prototype,e))),E=!1))}));let x=document.createElement;document.createElement=function(e){let t=x.apply(this,arguments);return"iframe"!=e||Object.defineProperty(t,"contentWindow",{configurable:!0,get:()=>{delete t.contentWindow;let e=t.contentWindow,n=e.document.write;return e.document.write=function(e){return n.call(this,e+'<script>!function(){"use strict";let e;const t=[];function n(t,n){if(!e?.skip_old||"g"!=n.data[0])return t.call(this,n)}window.addEventListener("message",(n=>{if(!Array.isArray(n.data)||n.data.length<1)return;let[a,...o]=n.data;if("set-all"!=a)return console.warn("Unknown command",a);e=JSON.parse(o[0]),t.forEach((e=>e()))})),window.parent.postMessage(["get-all"]),WebSocket=new Proxy(WebSocket,{construct(t,a){let o=new t(...a);return o.addEventListener("close",(()=>{e?.auto_reload&&window.top.document.location.reload()})),Object.defineProperty(o,"onmessage",{set:e=>o.addEventListener("message",n.bind(o,e))}),o}})}();\n<\/script>')},p.push((()=>t.contentWindow.postMessage(["set-all",JSON.stringify(h)],"*"))),e}}),t};const k=unsafeWindow.alert;unsafeWindow.alert=function(e){if(!h?.auto_reload||"Connection to server was lost - please refresh page to reconnect"!=e)return k.apply(this,arguments)};var C=Object.freeze({__proto__:null}),O=[],S=[];!function(e,t){if(e&&"undefined"!=typeof document){var n,o=!0===t.prepend?"prepend":"append",i=!0===t.singleTag,a="string"==typeof t.container?document.querySelector(t.container):document.getElementsByTagName("head")[0];if(i){var r=O.indexOf(a);-1===r&&(r=O.push(a)-1,S[r]={}),n=S[r]&&S[r][o]?S[r][o]:S[r][o]=c()}else n=c();65279===e.charCodeAt(0)&&(e=e.substring(1)),n.styleSheet?n.styleSheet.cssText+=e:n.appendChild(document.createTextNode(e))}function c(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),t.attributes)for(var n=Object.keys(t.attributes),i=0;i<n.length;i++)e.setAttribute(n[i],t.attributes[n[i]]);var r="prepend"===o?"afterbegin":"beforeend";return a.insertAdjacentElement(r,e),e}}(":has(>#feedback-banner){display:none}:has(>#canvasId){width:calc(100% - 440px)}#canvasId{height:100vh;width:100%}#wfp-ui-root{border:0;height:100vh;position:fixed;right:0;width:300px}#bottom-ad-area,#right-ad-area{display:none!important}",{}),a((e=>{GM_addElement(e.parentElement.parentElement.parentElement,"iframe",{id:"wfp-ui-root",src:"https://reino08.github.io/ByakkoNoPawaa#"+encodeURI(JSON.stringify(h))})})),window.addEventListener("message",(e=>{if(!Array.isArray(e.data)||e.data.length<1)return;const[t,...n]=e.data;if("set"==t){const[e,t]=n;h[e]=t}else"get-all"==t?e.source.postMessage(["set-all",JSON.stringify(h)]):console.warn("Unknown command",t)}));var T=Object.freeze({__proto__:null});
