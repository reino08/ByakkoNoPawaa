// ==UserScript==
// @name        White Fox Power
// @namespace   X+
// @match       *://*.whiteboardfox.com/*
// @run-at      document-start
// @homepageURL https://github.com/reino08/ByakkoNoPawaa
// @downloadURL https://reino08.github.io/ByakkoNoPawaa/白狐のパワー.user.js
// @noframes
// @grant       unsafeWindow
// @grant       GM.xmlHttpRequest
// @grant       GM_addElement
// @grant       GM_getValue
// @grant       GM_setValue
// ==/UserScript==
var e="AIzaSyC8xW9BmOuZJJknjuXLozD-0wfRdExoZMQ";function t(e){if("complete"==document.readyState)return e();window.addEventListener("load",e)}let n,o;const r=[];function i(e){if(o)return e(o);r.push(e),n||(n=setInterval((()=>{o=document.getElementById("canvasId"),o&&(clearInterval(n),r.forEach((e=>e(o))),r.splice(0))}),100))}const a=document.getElementsByTagName("h1")?.[0]?.textContent?.includes("403");(a||"/login.jsp"==document.location.pathname)&&t((async()=>{const t="abcdefghijklmnopqrstuvwxyz",n=e=>new Array(e).fill(0).map((e=>t[Math.floor(26*Math.random())])).join("");await l(`${document.location.origin}/logout`);const o=n(10),r=await async function(t,n,o){await fetch(`${c}/createAuthUri?key=${e}`,{...s,body:JSON.stringify({identifier:t,continueUri:`${document.location.origin}/login.jsp`})});let{idToken:r}=await fetch(`${c}/signupNewUser?key=${e}`,{...s,body:JSON.stringify({email:t,password:o,returnSecureToken:!0})}).then((e=>e.json()));return await fetch(`${c}/setAccountInfo?key=${e}`,{...s,body:JSON.stringify({idToken:r,displayName:n,returnSecureToken:!0})}),r}(`${n(16)}@${n(16)}.com`,o,n(20));var i;if(await function(e,t){return l(`${document.location.origin}/login?idToken=${e}&name=${encodeURI(t)}&redirect=%2F`)}(r,o),await(i=1250,new Promise((e=>setTimeout(e,i)))),a)return document.location.reload();const d=document.location.search,u=d.indexOf("redirect=");let f=d.substring(u).indexOf("&");if(-1==u)return document.location=document.location.origin;-1==f&&(f=void 0),document.location=document.location.origin+"/"+d.substring(u+9,f)}));const c="https://www.googleapis.com/identitytoolkit/v3/relyingparty",s={method:"POST",headers:[["Content-Type","application/json"]]};async function l(e){new Promise((t=>{const n=document.createElement("iframe");n.style.display="none",n.src=e,n.onload=()=>t(n.remove()),document.body.appendChild(n)}))}async function d(){let e=0,t=0,n=1;do{let{docs:o,totalCount:r}=await fetch(`${document.location.origin}/lobby?page=${n}`).then((e=>e.json()));e=r,t+=o.length,n++;for(let e of o){const t=document.createElement("div");t.className="wfp-board",document.body.appendChild(t),u(e,t)}}while(t<e)}async function u({domainUrl:e,diagramName:t,preferredUserName:n,activeUsers:o},r){const i=`${e}${t}`,a=document.createElement("a");a.href=i,a.textContent=`${n} (${o})`,r.appendChild(a),GM.xmlHttpRequest({url:i,method:"HEAD",onload:function(e){403==e.status&&(a.style.textDecoration="line-through")}})}"/lobby.jsp"==document.location.pathname&&(document.close(),t((()=>{document.body.innerHTML="";{const e=document.createElement("button");e.style.all="revert",e.textContent="Refresh",e.onclick=()=>{for(let e=document.getElementsByClassName("wfp-board"),t=e.length-1;t>=0;t--)e[t].parentNode.removeChild(e[t]);d()},document.body.appendChild(e)}d()})));/\/[0-9]{8}-[0-9]{4}-[0-9]{4}/.test(document.location.pathname)&&(Promise.resolve().then((function(){return k})),Promise.resolve().then((function(){return j})));const f=unsafeWindow.prompt;document.addEventListener("keydown",(e=>{if("g"!=e.key)return;let t=prompt("Enter repeated text (empty to clear):").substring(0,200);unsafeWindow.prompt=t?()=>t:f}));const m=[],p=new Proxy(new class{constructor(e){this.min_framerate=0,this.downscale=!1,this.skip_old=!1,this.auto_reload=!1,Object.assign(this,e)}}(GM_getValue("wfp-config",{})),{set(e,t,n,o){let r=e[t];if(r==n)return;let i=Reflect.set(e,t,n,o);return GM_setValue("wfp-config",p),"string"==typeof t&&m.forEach((e=>e(t,r,n))),i}});function h(e){e(void 0,p),m.push((t=>e(t,p)))}let g;i((e=>{g=e;const t=new MutationObserver(o),n={attributes:!0,attributeFilter:["width","height"]};function o(){t.disconnect();let e=g?.getBoundingClientRect();p?.downscale?(g.width=e.width/2,g.height=e.height/2):(g.width=e.width,g.height=e.height),t.observe(g,n)}t.observe(g,n),h((e=>{e&&"downscale"!=e||o()}))}));let w=EventTarget.prototype.addEventListener;EventTarget.prototype.addEventListener=function(e,t,n){return w.call(this,e,(function(e){if(e.clientX){let t=g?.getBoundingClientRect();if(t&&p?.downscale&&e.clientX>=t.x&&e.clientX<=t.x+t.width&&e.clientY>=t.y&&e.clientY<=t.y+t.height){console.log(t.width,g.width);let n=(e.clientX-t.x)*Math.SQRT1_2+t.x,o=(e.clientY-t.y)*Math.SQRT1_2+t.y;e.__defineGetter__("clientX",(()=>n)),e.__defineGetter__("clientY",(()=>o))}}return"function"==typeof t?t.call(this,e):t.handleEvent.call(this,e)}),n)};let y=performance.now(),v=0,b=!1;const E=["fillText","stroke"];!function e(){y=performance.now(),requestAnimationFrame(e)}(),h(((e,t)=>{e&&"min_framrate"!=e||(t.min_framerate?(v=1e3/t.min_framerate,b||(E.forEach((e=>function(e,t){const n=e[t];e[t]=function(){if(performance.now()-y<v)return n.apply(this,arguments)},e[t].original=n}(CanvasRenderingContext2D.prototype,e))),b=!0)):b&&(E.forEach((e=>function(e,t){e[t]=e[t].original}(CanvasRenderingContext2D.prototype,e))),b=!1))}));let _=document.createElement;document.createElement=function(e){let t=_.apply(this,arguments);return"iframe"!=e||Object.defineProperty(t,"contentWindow",{configurable:!0,get:()=>{delete t.contentWindow;let e=t.contentWindow,n=e.document.write;return e.document.write=function(e){return n.call(this,e+'<script>!function(){"use strict";let e;const t=[];function n(t,n){if(!e?.skip_old||"g"!=n.data[0])return t.call(this,n)}window.addEventListener("message",(n=>{if(!Array.isArray(n.data)||n.data.length<1)return;let[o,...r]=n.data;if("set-all"!=o)return console.warn("Unknown command",o);e=JSON.parse(r[0]),t.forEach((e=>e()))})),window.parent.postMessage(["get-all"]),WebSocket=new Proxy(WebSocket,{construct(t,o){let r=new t(...o);return r.addEventListener("close",(()=>{e?.auto_reload&&window.top.document.location.reload()})),Object.defineProperty(r,"onmessage",{set:e=>r.addEventListener("message",n.bind(r,e))}),r}});const o=new Promise((e=>{let t=window.parent.whiteboard.__sendStats;window.parent.whiteboard.__sendStats=function(n,o){return"end"==o&&function(e){let t=Object.entries(window),n=t.filter((([e,t])=>"function"==typeof t&&!t.toString().includes("[native code]")));e({all:t,functions:n})}(e),t.apply(this,arguments)}}));o.then((e=>{const t="$wnd.alert("+e.all.find((([e,t])=>"Copy command and image upload are currently disabled."==t))[0]+")";let n=e.functions.filter((([e,n])=>n.toString().includes(t)));for(const[e,o]of n){const n=o.toString(),r=n.indexOf(t);window[e]=new Function("return "+n.substring(0,r)+n.substring(r).replace("return","").replace(t,""))()}}))}();\n<\/script>')},m.push((()=>t.contentWindow.postMessage(["set-all",JSON.stringify(p)],"*"))),e}}),t};const x=unsafeWindow.alert;unsafeWindow.alert=function(e){if(!p?.auto_reload||"Connection to server was lost - please refresh page to reconnect"!=e)return x.apply(this,arguments)};var k=Object.freeze({__proto__:null});let S;var C=Object.freeze({__proto__:null,start:function(){const e=document.getElementById("canvasId"),t=e.getBoundingClientRect(),n=Math.floor(t.left),o=Math.floor(t.top),r=Math.floor(t.width),i=Math.floor(t.height);S&&clearInterval(S),S=setInterval((()=>{let t=e=>Math.floor(Math.random()*e);e.dispatchEvent(new MouseEvent("mousedown",{clientX:n+t(r),clientY:o+t(i)})),e.dispatchEvent(new MouseEvent("mousemove",{clientX:n+t(r),clientY:o+t(i)})),e.dispatchEvent(new MouseEvent("mouseup"))}))},stop:function(){clearInterval(S),S=void 0}}),M=Object.freeze({__proto__:null,randomDraw:C}),O=[],$=[];!function(e,t){if(e&&"undefined"!=typeof document){var n,o=!0===t.prepend?"prepend":"append",r=!0===t.singleTag,i="string"==typeof t.container?document.querySelector(t.container):document.getElementsByTagName("head")[0];if(r){var a=O.indexOf(i);-1===a&&(a=O.push(i)-1,$[a]={}),n=$[a]&&$[a][o]?$[a][o]:$[a][o]=c()}else n=c();65279===e.charCodeAt(0)&&(e=e.substring(1)),n.styleSheet?n.styleSheet.cssText+=e:n.appendChild(document.createTextNode(e))}function c(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),t.attributes)for(var n=Object.keys(t.attributes),r=0;r<n.length;r++)e.setAttribute(n[r],t.attributes[n[r]]);var a="prepend"===o?"afterbegin":"beforeend";return i.insertAdjacentElement(a,e),e}}(":has(>#feedback-banner){display:none}:has(>#canvasId){width:calc(100% - 440px)}#canvasId{height:100vh;width:100%}#wfp-ui-root{border:0;height:100vh;position:fixed;right:0;width:300px}#bottom-ad-area,#right-ad-area{display:none!important}",{}),i((e=>{GM_addElement(e.parentElement.parentElement.parentElement,"iframe",{id:"wfp-ui-root",src:"https://reino08.github.io/ByakkoNoPawaa#"+encodeURI(JSON.stringify(p))})})),window.addEventListener("message",(e=>{if(!Array.isArray(e.data)||e.data.length<1)return;const[t,...n]=e.data;if("set"==t){const[e,t]=n;p[e]=t}else if("get-all"==t)e.source.postMessage(["set-all",JSON.stringify(p)]);else if("macro"==t){const[e,t]=n;M[e][t?"start":"stop"]()}else console.warn("Unknown command",t)}));var j=Object.freeze({__proto__:null});
